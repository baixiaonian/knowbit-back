# 微信登录功能测试指南

## 测试步骤

### 1. 准备工作
- ✅ 微信公众号服务器配置已启用
- ✅ 后端环境变量已配置（Token、AppID、AppSecret）
- ✅ 后端服务正常运行

### 2. 测试流程

#### 步骤1：关注公众号
- 使用微信扫描公众号二维码或搜索公众号名称
- 确认已成功关注公众号

#### 步骤2：发送关键词
- 在公众号对话框输入：`666`
- 点击发送

#### 步骤3：接收验证码
- 应该在1-2秒内收到公众号客服消息
- 消息内容：`您的登录验证码：123456，请在1分钟内使用`
- 记录收到的验证码

#### 步骤4：前端登录
- 在前端登录页面输入收到的验证码
- 调用API：`POST /api/auth/wechat/verify`
- 请求体：`{"code": "收到的验证码"}`

#### 步骤5：验证登录
- 应该收到JWT token和用户信息
- 使用token进行后续API调用

## 可能的问题排查

### 问题1：发送"666"后没有收到验证码
**检查项：**
1. 后端日志是否有错误信息
2. AppID和AppSecret是否正确配置
3. 公众号是否开通了"客服消息"权限
4. 用户是否在48小时内与公众号有交互（关注或发送消息）

### 问题2：收到验证码但登录失败
**检查项：**
1. 验证码是否在有效期内（1分钟）
2. 验证码是否已使用
3. 数据库连接是否正常
4. 后端日志中的错误信息

### 问题3：微信回调验证失败
**检查项：**
1. URL是否正确可访问
2. Token是否与微信后台配置一致
3. 服务器时间是否准确
4. 后端服务是否正常运行

## 测试API接口

### 验证码验证接口
```bash
curl -X POST "https://api.knowbit.cn/api/auth/wechat/verify" \
  -H "Content-Type: application/json" \
  -d '{"code": "123456"}'
```

成功响应：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "wechat_openid": "oXXXXXXXXXXXXX",
      ...
    }
  }
}
```

## 日志检查

查看后端日志，关注：
- 用户发送"666"时的消息处理日志
- 验证码生成和发送日志
- Access Token获取日志
- 验证码验证日志

